# スプライト・ステージ拡張準備 計画

更新日: 2026-01-05

## プロンプト
次に以下の機能のどちらかを実装予定です。
- もし適切な画像ファイルがpublic配下に存在すれば、キャラクタースプライトにその画像をモードごとに表示する。
- ゲームを行うステージを選択したら、それに合わせたステージ構成jsonファイルを読み込み、それをもとにステージのセルを生成していく。
  - jsonの構成は別で検討中。
上記の機能に関わる箇所をリファクタリングして、上記の機能を実装しやすく整えておいてください。
まずは計画を立ててください。

- スプライト画像の対象はプレイヤーとNPC両方です。
- モードごとの対応表はありませんが、画像ファイル名は`public/character/{キャラクターを表す識別子, 詳細未定}/{モード名}.png`にします。
- ステージJSONは、`public/stage/{ステージを表す識別子、詳細未定}.json`に置きます。
- 読み込みタイミングは、タイトル画面でステージ選択時（今で言えば右クリック時）です。
- JSON項目は未定です。まだ中身に関わる実装はしないでください。
- リファクタ対象はどちらにも備えてください。

## ステップ
- [x] スプライト周り（プレイヤー/NPC）の設定値と生成処理を整理し、将来の画像差し替え口を追加できる配置に切り出す。
- [x] スプライト画像の参照ルール（`public/character/{id}/{mode}.png`）を扱う責務を一箇所に集約し、存在確認やロード処理を後から追加しやすい形にする。
- [x] ステージ定義の取り回しを分離し、`createGridLayout`/`createStageFromGrid`への入力を集約する。
- [x] タイトル画面でのステージ選択に備え、入力ハンドラとゲーム開始の分岐点を整理して差し込み口を作る。
- [x] mainの初期化手順を整理し、スプライト生成とステージ生成の依存関係を明確化する。
- [ ] 既存の動作（タイトル表示、開始、リトライ、ミニマップ表示）が変わらないことを目視で確認する。

## 結果
スプライト設定を`src/game/characterSprites.ts`に集約し、モード画像の読み込みとフォールバックを実装した。ステージ構成は`src/world/stageContext.ts`と`src/world/stageSelection.ts`に分離し、タイトル画面の右クリックでステージ選択・JSON読み込み（未定義時はデフォルト）できる差し込み口を用意した。HUDのタイトル文言更新と複数行表示に対応し、main側はステージ更新・スプライト生成・ゲームフロー再生成の整理を反映した。
