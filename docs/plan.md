# arena_trap_room NPC停止タイミング化 計画

更新日: 2026-02-08

## プロンプト
再起動で直りました。

実装修正に戻ります。
「NPC一時停止」ロジックを変更したいです。
- 全てのNPCは点滅が始まったときに、「点滅が始まってから光線の発射が始まるまでの秒数（5秒）」+「固定値0.5秒」=6.0秒の中から、自分がどのタイミングで停止するかをランダムで決定する。その秒数後に動きを止める。（計算は0.1秒刻み）
にしてください。これにより、一定数は足を止めきれないNPCがいるが、多数のNPCは徐々に足を止められる（不自然に一斉に止まらない）ようになる想定です。

## ステップ
- [x] 既存のNPC一時停止実装（5%継続移動）を確認
- [x] 点滅開始時にNPC停止タイミング（0.1秒刻み、0〜6.0秒）を割り当てる実装へ置換
- [x] 凍結窓（点滅開始〜持続ビーム終了）で、割当秒到達後のみ `normal/evade` を停止
- [x] `arena_trap_room` 限定適用を維持
- [x] 型チェック

## 結果
- `src/main.ts` のNPC一時停止特例を、以下へ置換した。
  - 旧仕様: 凍結窓に入るとNPCごとに5%で継続移動抽選
  - 新仕様: 点滅開始時に全NPCへ停止遅延秒数を割り当て（`0.0`〜`6.0` 秒、`0.1` 秒刻み）
- 凍結窓（`charging` またはトラップビーム残存中）では、`normal` / `evade` のNPCだけを対象に、
  `trapNpcFreezeElapsed >= 割当秒数` になった個体から順次停止するようにした。
- 停止はモード遷移ではなく、既存と同様に移動処理だけを特例でスキップする実装を維持した。
- `arena_trap_room` かつ `playing` 時のみ有効で、その他の状態では管理情報をクリアする。
- 検証として `npx tsc -p tsconfig.json --noEmit` を実行し、成功した。
