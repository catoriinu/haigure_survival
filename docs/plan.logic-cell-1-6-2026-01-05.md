# NPC移動仕様リッチ化 計画

更新日: 2026-01-05

## プロンプト
NPCの移動の仕様をリッチにしたいです。

NPCが斜め移動もできるようになる。すなわち、現在はセルの中央同士をつないだ線上しか動けない認識ですが、それ以外も自由移動できるようになってほしいです。
以下のような仕様を考えています。
- セル単位で、SRPGのような「移動力」を定義する。移動力の範囲のセル内で移動先を決め、そこにむけて最短距離で直進する
- 通常時はランダムに目的地となるセルを決める。到達したら次の場所を目的地として更新する。
- evade時は自分をターゲットしているビットやキャラから最も遠ざかれるセルを目的地として選ぶ。かつ、目的地の更新は1秒ごとに行う。

仕様について実現可能性やもっと決めるべきことを考え、実装計画を立ててください。

追加仕様:
- 移動力はNPC共通で12セル（将来的に状態別へ拡張の可能性あり）
- 移動力の距離コストは4方向1
- 移動可能な床セル（通路含む）は全て目的地候補
- 直進線上に壁がある場合は、移動可能セル上の最短距離で移動して目的地へ向かう
- normalの目的地選定は距離1=重み1、距離=移動力=重み3、間は比例（使い切るほど抽選されやすい）
- evadeの対象はbit.targetId、NPCの追跡対象、プレイヤーの照準
- evadeは対象の床面座標の重心から最も離れるセルを目的地にする（同値はランダム）
- evadeの目的地更新は1秒ごとに強制更新し、起点は現在セル

## ステップ
- [x] 仕様確認（移動力の値・距離コスト・斜め移動の扱い・壁/障害物の直進可否・evade対象/距離指標・1秒更新の挙動）
- [x] 現行NPC移動の把握と影響範囲整理（`src/game/npcs.ts`、必要な補助関数）
- [x] 移動先セル選定ロジックの設計（移動力BFS、normalは距離1=1〜距離=移動力=3の比例重み、evadeは脅威重心から最大距離・同値ランダム）
- [x] NPC移動更新の実装と調整（直進線の壁判定、遮蔽時は最短経路、evadeは1秒更新＋脅威マップ）
- [ ] 動作確認（斜め/自由移動、evadeの再選定、壁やブロッカーの挙動）

## 結果
- 移動力12セルのBFS到達セルから目的地を選定（normalは距離比例重み、evadeは脅威重心から最遠セル）
- 直進線上に壁がある場合は最短経路のセル中心ウェイポイントで移動
- evadeは1秒ごとに目的地更新し、bit.targetId/追跡NPC/プレイヤー照準を脅威に反映
- 動作確認は未実施
