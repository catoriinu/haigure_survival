# アリーナ（ルーレット）実装 計画

更新日: 2026-02-23

## プロンプト
PLEASE IMPLEMENT THIS PLAN:
# アリーナ（ルーレット）実装実行計画（コミット分割）

## 要約
ルーレット専用フェーズを追加し、タイトル設定制限、離散停止ロジック、同時命中演出、複数段Undoを段階実装する。
各段階で `npm run build` を通してからコミットし、`push` は実施しない。

## コミット計画

1. `feat: ルーレット選択時のタイトル設定制限を追加`
- 対象:
  - `src/ui/defaultSettingsPanel.ts`
  - `src/ui/brainwashSettingsPanel.ts`
  - `src/ui/bitSpawnPanel.ts`
  - `src/ui/stageSelectControl.ts`
  - `src/main.ts`
- 内容:
  - `NPC初期人数` 以外を disabled 化する API を各パネルに追加
  - `arena_roulette` 選択時だけ設定制限を有効化
  - 開始時にルーレットでは `initialNpcCount` 以外を実行時無視

2. `feat: ルーレット専用フェーズと入力経路を追加`
- 対象:
  - `src/game/flow.ts`
  - `src/ui/input.ts`
  - `src/world/stageIds.ts`
  - `src/main.ts`
- 内容:
  - `GamePhase` に `roulette` を追加
  - `R` キーのルーレットUndoハンドラ経路を追加
  - `Enter` でタイトル復帰の分岐を `roulette` に対応

3. `feat: ルーレット進行と離散停止ロジックを実装`
- 対象:
  - `src/main.ts`（必要なら `src/game` 配下に分離）
- 内容:
  - 開始直後の円陣配置（全員 `evade`、中央向き、移動不可）
  - ビット数抽選: `1..max(1, floor(参加者総数/2))`
  - 停止位置をキャラ背後スロットの離散値に限定
  - 10秒回転プロファイル（加速1秒、巡航4秒、減速5秒）
  - 停止1秒後に発射判定
    - 停止先が洗脳済みキャラなら不発
  - 命中演出を同時進行で更新し、`brainwash-complete-haigure` へ遷移
  - 演出完了1秒後に再抽選して次ラウンドへ
  - 全員洗脳で終了状態へ

4. `feat: ルーレットの複数段Undoを実装`
- 対象:
  - `src/main.ts`
- 内容:
  - ラウンド開始前スナップショット履歴を保存
  - `R` で1段巻き戻し（複数段対応、初回まで）
  - Redo不可（Undo後に未来履歴破棄）
  - フェード演出付き巻き戻し

5. `docs: ルーレット仕様と操作をREADMEに反映`
- 対象:
  - `README.md`
  - `docs/plan.md`
- 内容:
  - ルーレット仕様、設定制限、Undo操作、停止離散仕様を追記
  - 実装結果を `docs/plan.md` に最終反映

## テスト・確認（各コミット後）
- `npm run build` 成功
- `arena_roulette` で:
  - 設定制限表示
  - 離散停止
  - 洗脳済み背後ビット不発
  - 同時命中演出
  - 複数段Undo
- 他ステージ回帰なし

## 前提
- `push` は行わない。
- 文字コードは UTF-8(BOMなし) で統一する。

## ステップ
- [x] ルーレット選択時のタイトル設定制限を追加
- [x] ルーレット専用フェーズと入力経路を追加
- [x] ルーレット進行と離散停止ロジックを実装
- [x] ルーレットの複数段Undoを実装
- [x] README反映と最終確認を実施

## 結果
- `arena_roulette` 選択時はタイトル設定を `NPC初期人数` のみ編集可能にし、実行時も同項目以外を無効化するようにした。
- `GamePhase` に `roulette` を追加し、`Enter` でタイトル復帰、`R` でルーレットUndoの入力経路を追加した。
- ルーレット進行を実装した。
  - 開始直後の円陣配置（全員 `evade`、中央向き、移動不可）
  - ビット数抽選 `1..max(1, floor(参加者総数/2))`
  - 離散停止（必ずキャラ背後スロットに停止）
  - 10秒回転プロファイル（加速1秒、巡航4秒、減速5秒）
  - 停止1秒後の発射判定と、停止先が洗脳済みキャラの場合の不発
  - 同時命中演出の進行更新と `brainwash-complete-haigure` への遷移
  - 演出完了1秒後の再抽選ループと、全員洗脳時の終了
- ルーレットUndoを実装した。
  - ラウンド開始前スナップショット履歴を保存
  - `R` で1段巻き戻し（複数段対応、初回まで）
  - Undo時に未来履歴を破棄し、Redoなし
  - フェード演出を伴う巻き戻し
- ドキュメントを更新した。
  - `README.md` にルーレット仕様・制限・操作を追記
  - 旧計画を `docs/plan_2026-02-23_before-roulette-plan.md` へ退避し、新計画を本ファイルに反映
- 各コミット後に `npm run build` を実行し、成功を確認した。
