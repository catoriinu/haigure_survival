# ビーム回避FPS（仮）仕様書（最終改訂版）

更新日: 2026-01-11

## 1. ゲーム概要
本作は、3D空間内でプレイヤーおよび複数のNPCが同一フィールドに存在し、
空中を飛行する複数のビットから発射されるビームを回避し続ける
生存時間スコアアタック型FPSゲームである。

キャラクター（プレイヤー・NPC）は一枚絵で表現され、
敵であるビットは3Dオブジェクトとして表現される。
フィールド内の全キャラクターが撃破された時点でゲームオーバーとなる。

## 2. ゲームの最小完成条件（MVP）
以下の条件をすべて満たした時点で、本作は「完成」とみなす。

- プレイヤーが操作可能であること
- タイトル画面が存在すること
- ゲーム中、以下の操作が可能であること
  - 前後移動
  - 左右移動
  - マウスによる視点操作
- 屋内フィールドが1種類以上存在すること
- フィールド内にプレイヤー以外のNPCが存在すること
- プレイヤーおよびNPCが一枚絵キャラクターとして表示されること
- 敵ビットが3Dオブジェクトとして表示されること
- ビームに当たると、プレイヤー・NPCともに戦闘不能になること
- 全キャラクター（プレイヤー＋NPC）が撃破された場合にゲームオーバーとなること
- ゲームオーバー時に全滅シーン（エピローグ）が表示されること
  - 生存時間が表示される
- リトライが容易であること
- 終了条件を満たした後、タイトル画面に戻れること

## 3. 視点・操作仕様
### 視点
- 完全FPS視点
- プレイヤーの体モデルは使用しない
- カメラを基準とした一人称視点

### 操作
- 移動：前後・左右
- 視点操作：マウス
- ジャンプ：なし

### 操作補足（追記）
- FPS視点のため、ゲーム開始時にポインタロックを有効化する
- ポインタロック解除はEscキーで行える

## 4. フィールド仕様
### 共通仕様
- 箱型の閉じた空間を基本とする（屋外は天井なしを許容）
- 屋内は壁・床・天井を持つ
- フィールド外への移動は不可

### フィールド生成ルール（追記）
- フィールドはセル状のグリッドで管理する
- セルサイズ：12 x 12
- グリッドサイズ：20 x 20 セル
- 天井高さ：1セル（自動生成のデフォルト）
- 天井の有無/高さはステージ定義で上書き可能
- セルの状態：床 / 壁
- 連結した床セルは「部屋」として扱う
- 1セル幅の床が連続し、両脇が壁の場合は「道」として扱う
- 初期ルール：小大大大小の5部屋が一本道で繋がる
- 両端の小部屋にはNPC/ビットは初期配置されない（移動で侵入は可能）
- プレイヤーの初期位置は左端の小部屋とする

### 屋内フィールド（優先実装）
- 種別：屋内
- 空間イメージ：建物内部・部屋
- 床：
  - 色：紫色
  - 2単位ごとの格子線を入れる
- 壁・天井：
  - 色：灰色
  - 壁は2単位ごとの格子線を入れる
- 視認性を重視し、キャラクターやビームが見やすい配色とする

### 屋外フィールド（部分対応）
- env=Oセルの床色/空色の切り替えのみ対応
- 天井なしを許容
- 屋外専用の配置/演出ルールは未定

## 5. キャラクター共通仕様（プレイヤー・NPC）
### 表現方法
- キャラクターは一枚絵（スプライト）で表現する
- 常にカメラ正面を向くように回転追従する（ビルボード方式）
- キャラクターは縦長の長方形（基準比率 330:700、画像サイズに合わせて縦横比を維持）
- 基準スプライトの横幅は1.2ユニットとする
- 見た目と当たり判定は独立して扱う

### 当たり判定
- 当たり判定形状：円柱型
- 当たり判定は内部処理用であり、可視化しない

### 状態定義（ステータス）
- normal：下記以外の通常状態（isAlive=true）
- evade：自分がビットまたはbrainwash-completeのNPCにターゲットされていることに気付いている（isAlive=true）
- hit-a：命中エフェクトのピンク時、またはピンクのフェード中（isAlive=false）
- hit-b：命中エフェクトの水色時（isAlive=false）
- brainwash-in-progress：ビームに撃たれた後の行動不能中（isAlive=false）
- brainwash-complete-gun：洗脳完了・銃所持（移動可、攻撃は別途実装）（isAlive=false）
- brainwash-complete-no-gun：洗脳完了・銃不所持（移動可、追尾ロジックは別途実装）（isAlive=false）
- brainwash-complete-haigure：洗脳完了・ハイグレ（移動不可、立ち尽くし）（isAlive=false）
- brainwash-complete-haigure-formation：洗脳完了・ハイグレ（整列、全滅シーン用）（isAlive=false）

## 6. プレイヤーの仕様
### 基本仕様
- FPS操作主体となるキャラクター
- 移動・視点操作が可能
- 初期配置は必ず部屋の内部とする
- 初期の視線方向は、部屋から道に向かう方向とする

### 表示に関する方針
- プレイヤー自身の一枚絵表示については未確定
- 実装する場合はNPCと同等のビルボード方式を採用する

### 被弾ルール
- ビームに1回でもヒットするとhit-a/hit-b状態になる
- hit-a/hit-b状態は3秒継続し、その間は命中エフェクト（半透明の球体、ピンクと水色を高速に切り替え）を表示する
- hit-a/hit-b状態から3秒経過でhit-a状態のピンクフェードに移行する
- hit-a状態のピンクフェードは1秒かけて透明になり、その後brainwash-in-progress状態に移行する
- brainwash-in-progress中は操作不能となるが、ゲームは継続する

### 洗脳後の分岐（PC）
- brainwash-in-progressになってから10秒経過すると、以下の文字と入力受付を開始する
  - press G to move with gun
  - press N to move without gun
  - press H to haigure
- 上記G/N/Hの選択は、一度brainwash-in-progressになった後～全滅するまでの間、常に可能
- G選択（brainwash-complete-gun）
  - WASDで移動可能
  - 左クリックで画面中央に向けてビーム発射（クリック毎に発射）
  - 生存しているキャラクターに命中可能
- N選択（brainwash-complete-no-gun）
  - WASDで移動可能
  - ビームは発射不可
  - 生存しているキャラクターに自分が衝突している間、相手の移動を封じる（離れると解除）
- H選択（brainwash-complete-haigure）
  - 移動不可
  - ボイスが切り替わるのみ
- カメラはその場で待機可能

## 7. NPC（味方キャラクター）の仕様
### 基本仕様
- プレイヤーと同陣営のノンプレイヤーキャラクター
- フィールド内に複数体存在する
- 攻撃能力は持たない
- 初期人数：12体

### 行動
- フィールド内をランダム、またはルールに基づいて走り回る
- ビットの攻撃対象となる

### 表示状態（ステータス別）
NPCの一枚絵は、以下の少なくとも3状態で切り替える。

1. normal/evade
2. hit-a/hit-b
3. brainwash-in-progress

各状態は別画像として管理する。
指定画像がない場合は仮スプライトを表示する。

### 被弾ルール
- ビームに1回でもヒットするとhit-a/hit-b状態になる
- hit-a/hit-b状態は3秒継続し、その間は命中エフェクト（半透明の球体、ピンクと水色を高速に切り替え）を表示する
- hit-a/hit-b状態から3秒経過でhit-a状態のピンクフェードに移行する
- hit-a状態のピンクフェードが完了するとbrainwash-in-progress状態になる
- brainwash-in-progress後は行動不能、復活なし

### 洗脳後の分岐（NPC）
- brainwash-in-progressになってから10秒経過すると、以下の抽選を行う
  - brainwash-in-progressのまま（50%）
    - その10秒後に再抽選
  - brainwash-complete-haigureへ遷移（50%）
- brainwash-complete-haigureになってから10秒経過すると、以下の抽選を行う
  - brainwash-complete-gunへ遷移（50%）
  - brainwash-complete-no-gunへ遷移（50%）
- brainwash-complete-gun
  - ビットの索敵/追尾モード相当で行動し、生存中のキャラクターを狙う
  - 銃の向きはNPCの実際の移動方向（ビルボード向きではない）
- brainwash-complete-no-gun
  - ビットの索敵/追尾モード相当で行動し、生存中のキャラクターに近づく
  - 生存中のキャラクターに衝突している間、相手の移動を封じる
  - 移動封じ中はno-gunのNPC自身も動かない
  - 詰み防止のため、20秒後に移動して対象から離れる

## 8. 敵（ビット）の仕様
### 基本仕様
- 敵は「ビット」と呼ばれる
- 初期出現数：1体
- 時間経過により出現数が増加する
- 出現間隔：10秒ごと

### 見た目（ビジュアル仕様）
- 3Dオブジェクトとして表現する
- 形状：
  - 基本形状：円錐
  - 錐の頂点部分に、丸い発射口を持つ
- 状態：
  - 常に空中に浮遊している
- 発射口は、ビームの発射方向を視覚的に示す役割を持つ

### 配置・移動
- フィールド内の上空を浮遊
- 前後・左右・上下すべての方向に移動可能
- 壁や天井を越えない範囲で上下移動する
- プレイヤー/NPCの真上（水平半径3メートル以内）には侵入しない
- 移動速度の目安：索敵3.0、追尾1.8、ランダム3.4、基本2.4
- 追尾は射程外のみ索敵速度で移動し、射程内で追尾速度になる
- 絨毯爆撃の移動速度：黒9.0、赤は0.92倍

### 行動・ターゲット
- 攻撃対象：プレイヤー、NPC
- 戦闘不能になったキャラクターは対象外
- 感知距離：黒32、赤64（距離強化係数で倍率調整可能）
- 視野角：黒100度、赤150度（視野角強化係数で倍率調整可能）
- 視野判定は前方ベクトル基準の円錐判定（上下含む）

### 移動・浮遊
- 通常時は上下にふわふわ揺れる（振幅0.35）
- alertと絨毯爆撃は上下揺れなし
- 索敵中は前進/斜め前進/その場上下のパターンで移動する
  - その場上下は水平向きのまま上下する
- 索敵中は時々停止して下向き＋左右に旋回して探索する
  - 上向き探索はしない
  - 高度差が小さい場合は水平向きのまま旋回する

### 行動モード
ビットは以下のモードを持ち、条件に応じて遷移する。
- 索敵モード
  - ビーム：発射しない
  - ランダム移動と停止旋回で探索する
  - 視野内のターゲット発見時、攻撃モードまたは警戒モードへ移行する
- 攻撃モード（追尾）
  - 継続時間：15秒
  - ビーム：ターゲット方向に正確に狙う
  - 発射条件：視野角内かつ距離12以内
  - 発射間隔：3.0-4.0秒
  - 追尾中は移動しながら発射する
  - ターゲットが遠い場合は索敵速度で接近し、射程内で追尾速度に切り替える
  - ターゲットが一定距離（24）より離れると索敵モードに移行する
- 攻撃モード（固定）
  - 継続時間：10秒
  - ビーム：攻撃モードに移行した時点の方向に発射する
  - 発射間隔：1.0-1.6秒
  - 移動は行わない（高度変更も行わない）
  - ターゲットの消失や距離では解除されず、時間経過や割り込みのみで解除される
  - 赤ビットは弾ごとにターゲット方向へ補正する
- 攻撃モード（ランダム）
  - 継続時間：10秒
  - ビーム：現在の向きに発射する
  - 発射間隔：0.8-1.4秒
  - ランダムに移動・旋回しながら攻撃する
  - 発射モーション中は移動と旋回を停止する
  - ターゲットの消失や距離では解除されず、時間経過や割り込みのみで解除される
- 絨毯爆撃モード
  - 3機編隊でターゲット方向へ進行しながらビームを降らせる
  - 発射間隔：0.25秒（赤は1.3倍の頻度）
  - ターゲットを超えて一定時間（3.0秒）で編隊を解除し索敵モードに移行する
- 警戒モード
  - 継続時間：15秒
  - ビーム：発射しない
  - リーダーが上向き待機し、受信ビットが集合する
  - 移動中にターゲットを視野内で発見した場合、集合扱いで即攻撃モードに移行する
  - リーダーとターゲットが感知距離の1.5倍以上離れると警戒解除に移行する
  - 水平向きに戻ってから索敵モードに移行する
- 自身のビームが命中したキャラクターがhitの間は停止し、ビームを発射しない
- 命中したキャラクターがdownになったら索敵モードに戻る
- 将来的なモード追加や遷移条件の拡張を前提とする

### モード遷移確率
- 索敵からの遷移（黒ビット）：追尾45% / 固定20% / ランダム15% / 警戒10% / 絨毯爆撃10%
- 索敵からの遷移（赤ビット）：追尾70% / 固定20% / 絨毯爆撃10%
- 警戒集合後（全ビット）：追尾60% / 固定20% / 絨毯爆撃20%

### クールダウン
- 攻撃系モード終了時（時間経過または諦め）に3秒の共通クールダウンを入れる
- 割り込み終了（被弾ホールドや壁接触など）はクールダウン対象外
- 絨毯爆撃は壁接触時のみ専用クールダウン2.5秒が発生する

## 9. 攻撃（ビーム）の仕様
- 攻撃手段：円柱型ビーム
- 発射元：ビットの発射口
- 発射方向：基本は直線
- 発射口（円錐頂点）の向きに合わせて発射する
- 太さ：細め
- 速度：避けにくいが回避可能な速さ
- 同時存在数：多め
- 寿命：
  - フィールド外に出たら消滅
  - 壁・床・天井に命中したら消滅
  - キャラクターに命中したら消滅

## 10. 当たり判定ルール
- 判定対象：
  - ビーム × プレイヤー
  - ビーム × NPC
- ビームが対象キャラクターに接触した場合、ヒットと判定
- ヒット時の結果：
  - hit状態に移行し、その後のdown遷移は各キャラクター仕様に従う

## 11. ゲーム進行・終了ルール
### 状態定義
- 生存中（normal/evade）：プレイヤー操作可能
- プレイヤー戦闘不能（hit-a/hit-b/brainwash-in-progress）
  - 操作不能
  - 観戦・待機状態
  - NPCとゲーム進行は継続
  - Enter入力で全滅シーン（エピローグ）へ移行できる
- brainwash-in-progressから10秒後、G/N/H入力でbrainwash-complete系に移行可能
- 全滅
  - プレイヤーおよび全NPCが戦闘不能（hit-a/hit-b/brainwash-in-progress/brainwash-complete-*/brainwash-complete-haigure-formation）
  - ゲームオーバー
  - 全員brainwash-in-progress以降になってから3秒経過で全滅シーン（エピローグ）へ移行する

### スコア
- スコア形式：生存時間
- 計測終了タイミング：全滅時
- プレイヤーがhitした時点の経過時間を保存する
- 全滅時の経過時間を保存する

## 12. 難易度変化の方針
- 時間経過により難易度上昇
- 主な変化要素：
  - ビット出現数の増加
  - ビーム発射頻度の増加

## 13. 演出・表現方針
- エフェクトは比較的派手にしてよい
- ビットの発射口・ビーム発射方向が視覚的に分かることを重視する

## 14. 今回やらないこと（非対象）
- プレイヤー・NPCの3Dモデル実装
- 敵の高度なAIロジック
- 物理エンジン依存の複雑な挙動
- 屋外フィールドの実装
- ストーリー要素

## 15. 開発方針メモ
- 一枚絵（キャラ）＋3D（敵）の混在前提で設計する
- 見た目と当たり判定を明確に分離する
- 屋内フィールドを基準にゲームバランスを調整する
- 将来、屋外フィールド追加を想定した拡張可能な構成とする

## 16. 画面構成・遷移（追記）
- タイトル画面（left click to start） → ゲーム画面 → 全滅シーン（エピローグ） → タイトル画面
- プレイヤーがbrainwash系状態のときEnterで全滅シーンへ、全滅シーンでEnterでタイトルに戻る
- brainwash-in-progressから10秒経過で「press G/N/H」の案内を表示する

## 17. プラットフォーム・配布（追記）
- ブラウザ配布：Viteビルド成果物
- Windows配布：Electronビルド成果物

## 18. ミニマップ（追記）
- 画面左上に常時表示する
- 現在地を中心に表示する
- フィールドを上から見たときに、床/壁が色で判別できる
- プレイヤーの向きに合わせてミニマップ全体が回転する
- 将来的にボタンでオン/オフ切り替え可能にする
- 現在座標をミニマップ付近に表示する
- プレイヤーの視界方向を扇形で表示する（扇形は常に上向き）
- 生存中のキャラクター数（PC + NPC）を表示する
- 経過時間をリアルタイム表示する
- プレイヤーがbrainwash系状態のとき、生存時間と「press Enter to epilogue」を表示する
- 全滅シーンではHUDを非表示とし、「press Enter to title」を表示する

## 19. もし3Dモデル化するなら（明示的な指示があるまでこのセクションは無視すること）
- 優先順はNPC → PCの順とする（NPCでの動作/切替が安定してからPCへ拡張）
- NPC/PCともに同一フォーマットのスケルトン付きモデルを前提にする
- アニメーションはIdle/Walk/Hit/Brainwash系の最低限を想定する

### 19.1 モデル形式・制作条件
- 形式はglTF/GLBを採用する
- スケルトン付きのスキンドメッシュであること
- NPC/PCの身長は横幅1.2ユニットに対して約2.12（=700/330）に合わせる
- アニメーションは同一リグ前提で、同一GLBに内包する
- 必須アニメーション名は以下で統一する
  - Idle
  - Walk
  - Hit
  - Brainwash

### 19.2 Babylon.js側の読み込み方針
- `@babylonjs/loaders` を導入し、glTF読み込みを有効化する
- `SceneLoader.LoadAssetContainerAsync` でベースモデルを読み込み、NPCごとに `instantiateModelsToScene()` で複製する
- NPCの各インスタンスは「root TransformNode + skinned mesh + AnimationGroup群」を1セットとして管理する

### 19.3 NPCの置き換え方針
- `Sprite` ベースの管理を廃止し、3DモデルのrootノードをNPC位置の基準とする
- `npc.sprite.position` を `npc.root.position` に置き換え、移動/被弾/ビーム発射位置を統一する
- 既存の当たり判定（円柱相当）はモデルの見た目サイズに合わせて固定値で運用する
- 状態遷移とアニメーションの対応を以下に固定する
  - normal/evade: Walk（移動中）/ Idle（停止中）
  - hit-a/hit-b: Hit
  - brainwash-in-progress: Brainwash
  - brainwash-complete-* : Walk/Idle

### 19.4 PCの置き換え方針
- FPS視点は維持し、PCモデルは視界用途ではなく「他者から見える体」として扱う
- 通常プレイ中はカメラ位置に追従させる（assembly演出時のみ独立移動）
- 現行の `playerAvatar` を3Dモデルに置き換え、`GameFlow` の整列演出で可視化する
- 状態遷移とアニメーションの対応はNPCと同一とする

### 19.5 アニメーション切替の運用
- 移動量（速度）に応じてIdle/Walkを切替する
- Hit/Brainwash系は状態遷移時に即時再生し、終了後は状態に応じたIdle/Walkへ戻す
- 切替はAnimationGroup単位で制御し、同時再生は行わない
