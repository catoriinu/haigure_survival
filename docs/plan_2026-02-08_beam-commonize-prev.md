# 公開処刑NPC斉射ビーム消失修正 計画

更新日: 2026-02-08

## プロンプト
「最後の未洗脳者がPCでNPCに捕まった場合」の確認をしました。
NPCの見た目、ボイス、光線発射まではOKでした。
その発射された光線が、発射音はしたのですがどこかに消えてしまい、プレイヤーに向かって飛んできて命中しませんでした。

## ステップ
- [x] 既存 `docs/plan.md` を退避し、新規 `docs/plan.md` を作成
- [x] 原因箇所（公開処刑NPC斉射ビームの衝突判定）を特定
- [x] 発射元NPCとの自己衝突を除外する修正を実装
- [x] NPC斉射ビームの生成位置を発射方向へ補正
- [x] 型チェックとビルド確認を実行
- [x] `docs/plan.md` の結果を更新

## 結果
`src/main.ts` の公開処刑NPC斉射処理で、ビームが発射直後に消える原因を修正した。
原因は、NPC由来ビームがNPC衝突判定で発射元NPC自身に即時ヒットしていたことだったため、公開処刑衝突判定で `beam.sourceId === npc.sprite.name` のNPCを除外するようにした。
加えて、NPC斉射ビームの生成位置を発射方向へ `npcHitRadius + 0.02` だけ前進させ、発射元の当たり判定内部から生成されないようにした。
これにより、発射音のみで消える挙動を解消し、PC方向へビームが飛行して命中判定される経路に修正した。
`npx tsc -p tsconfig.json --noEmit` と `npm run build:renderer` が成功した。